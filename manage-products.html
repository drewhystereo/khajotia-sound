<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Products - Khajotia Sound</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #10b981;
            --secondary-dark: #059669;
            --danger: #ef4444;
            --danger-dark: #dc2626;
            --warning: #f59e0b;
            --background: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom, #ffffff, #f8fafc);
            min-height: 100vh;
            color: var(--text);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            color: var(--text);
            font-weight: 600;
            font-size: 1.25rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            border-radius: 0.75rem;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.35);
        }

        .btn-secondary {
            background: var(--background);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--surface);
            transform: translateY(-1px);
        }

        main {
            padding: 2rem 0;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .page-subtitle {
            color: var(--text-muted);
            font-size: 1.125rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            border: 1px solid var(--border);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .products-section {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
        }

        .search-bar {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            min-width: 300px;
        }

        .search-bar input {
            border: none;
            background: none;
            outline: none;
            flex: 1;
            font-size: 0.875rem;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .product-card {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }

        .product-image {
            height: 180px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            position: relative;
        }

        .product-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .product-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .product-info {
            padding: 1rem;
        }

        .product-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }

        .product-price {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .product-description {
            color: var(--text-muted);
            font-size: 0.875rem;
            line-height: 1.4;
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            /* Standard properties for better browser compatibility */
            display: box;
            line-clamp: 2;
            box-orient: vertical;
        }

        .product-features {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-bottom: 1rem;
        }

        .feature-tag {
            background: var(--surface);
            color: var(--text-muted);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            border: 1px solid var(--border);
        }

        .product-actions {
            display: flex;
            gap: 0.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .btn-small {
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            border-radius: 0.5rem;
        }

        .btn-edit {
            background: var(--primary);
            color: white;
        }

        .btn-edit:hover {
            background: var(--primary-dark);
        }

        .btn-delete {
            background: var(--danger);
            color: white;
        }

        .btn-delete:hover {
            background: var(--danger-dark);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state .material-icons {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--background);
            color: var(--text);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text);
            font-size: 0.875rem;
        }

        input[type="text"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .price-input-group {
            position: relative;
        }

        .price-input-group::before {
            content: '₹';
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-weight: 600;
            color: var(--text-muted);
        }

        .price-input-group input {
            padding-left: 2rem;
        }

        .features-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .feature-input-group {
            display: flex;
            gap: 0.5rem;
        }

        .feature-input-group input {
            flex: 1;
        }

        .remove-feature-btn {
            padding: 0.75rem;
            background: #fee2e2;
            color: var(--danger);
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .remove-feature-btn:hover {
            background: #fecaca;
        }

        .add-feature-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--background);
            color: var(--primary);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            margin-top: 0.5rem;
        }

        .add-feature-btn:hover {
            background: var(--primary);
            color: white;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .image-upload-area {
            border: 2px dashed var(--border);
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
            background: var(--background);
        }

        .image-upload-area:hover {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.02);
        }

        .upload-icon {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .upload-text {
            color: var(--text);
            font-weight: 500;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }

        .upload-subtext {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        input[type="file"] {
            display: none;
        }

        .image-preview {
            margin-top: 1rem;
            display: none;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }

            .page-title {
                font-size: 2rem;
            }

            .section-header {
                flex-direction: column;
                align-items: stretch;
            }

            .search-bar {
                min-width: auto;
            }

            .products-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 1rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <span class="material-icons">speaker_group</span>
                    Khajotia Sound
                </a>
                <div class="header-actions">
                    <a href="index.html" class="btn btn-secondary">
                        <span class="material-icons">store</span>
                        View Website
                    </a>
                    <a href="add-product.html" class="btn btn-primary">
                        <span class="material-icons">add</span>
                        Add Product
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="page-header">
                <h1 class="page-title">Manage Products</h1>
                <p class="page-subtitle">View, edit, and manage your product inventory</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalProducts">0</div>
                    <div class="stat-label">Total Products</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="customProducts">0</div>
                    <div class="stat-label">Products Added</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgPrice">₹0</div>
                    <div class="stat-label">Average Price</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalValue">₹0</div>
                    <div class="stat-label">Total Value</div>
                </div>
            </div>

            <div class="products-section">
                <div class="section-header">
                    <h2 class="section-title">All Products</h2>
                    <div class="search-bar">
                        <span class="material-icons" style="font-size: 1.25rem; color: var(--text-muted);">search</span>
                        <input type="text" id="searchInput" placeholder="Search products...">
                    </div>
                </div>

                <div class="products-grid" id="productsGrid">
                    <!-- Products will be loaded here -->
                </div>

                <div class="empty-state" id="emptyState" style="display: none;">
                    <span class="material-icons">inventory_2</span>
                    <h3>No products found</h3>
                    <p>Start by adding your first product</p>
                    <a href="add-product.html" class="btn btn-primary" style="margin-top: 1rem;">
                        <span class="material-icons">add</span>
                        Add First Product
                    </a>
                </div>
            </div>
        </div>
    </main>

    <!-- Edit Product Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Product</h3>
                <button class="modal-close" onclick="closeEditModal()">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="form-group">
                        <label for="editProductName">Product Name *</label>
                        <input type="text" id="editProductName" required>
                    </div>
                    <div class="form-group">
                        <label for="editProductPrice">Price *</label>
                        <div class="price-input-group">
                            <input type="number" id="editProductPrice" required min="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editProductDescription">Description *</label>
                        <textarea id="editProductDescription" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Product Image</label>
                        <div class="image-upload-area" id="editUploadArea">
                            <span class="material-icons upload-icon">cloud_upload</span>
                            <div class="upload-text">Click to change image</div>
                            <div class="upload-subtext">Leave empty to keep current image</div>
                            <input type="file" id="editImageInput" accept="image/*">
                        </div>
                        <div class="image-preview" id="editImagePreview">
                            <img id="editPreviewImg" src="" alt="Product preview">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Key Features</label>
                        <div class="features-container" id="editFeaturesContainer">
                            <!-- Features will be loaded here -->
                        </div>
                        <button type="button" class="add-feature-btn" onclick="addEditFeature()">
                            <span class="material-icons">add</span>
                            Add Feature
                        </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveProduct()">
                    <span class="material-icons">save</span>
                    Save Changes
                // First try to load from JSONBin.io
                const products = await window.productStorage.loadProducts();
                console.log('Loaded products from JSONBin.io:', products);
                allProducts = [...defaultProducts, ...products];
                renderProducts();
                updateStats();
            } catch (error) {
                console.error('Error loading products from JSONBin.io, using default products:', error);
                allProducts = [...defaultProducts];
                renderProducts();
                updateStats();
            }
        }

        // Render products
        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            const emptyState = document.getElementById('emptyState');
            
            console.log('Rendering products, total:', allProducts.length);
            
            let filteredProducts = allProducts;
            
            if (searchQuery) {
                filteredProducts = allProducts.filter(product => 
                    product.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    product.description.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    product.features.some(feature => feature.toLowerCase().includes(searchQuery.toLowerCase()))
                );
            }

            console.log('Filtered products:', filteredProducts.length);

            if (filteredProducts.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            emptyState.style.display = 'none';

            grid.innerHTML = '';
            
            filteredProducts.forEach(product => {
                console.log('Rendering product:', product.name, 'ID:', product.id, 'isDefault:', product.isDefault);
                
                const card = document.createElement('div');
                card.className = 'product-card';
                
                card.innerHTML = `
                    <div class="product-image">
                        <img src="${product.imageUrl}" alt="${product.name}" 
                             onerror="this.src='https://placehold.co/300x200/f1f5f9/64748b?text=Product+Image'">
                        ${product.isDefault ? '<div class="product-badge">Default</div>' : ''}
                    </div>
                    <div class="product-info">
                        <h3 class="product-name">${product.name}</h3>
                        <div class="product-price">${product.price}</div>
                        <p class="product-description">${product.description}</p>
                        <div class="product-features">
                            ${product.features.slice(0, 3).map(feature => 
                                `<span class="feature-tag">${feature}</span>`
                            ).join('')}
                            ${product.features.length > 3 ? 
                                `<span class="feature-tag">+${product.features.length - 3} more</span>` : ''}
                        </div>
                        <div class="product-actions">
                            ${!product.isDefault ? `
                                <button class="btn btn-small btn-edit" data-id="${product.id}">
                                    <span class="material-icons" style="font-size: 1rem;">edit</span>
                                    Edit
                                </button>
                                <button class="btn btn-small btn-delete" data-id="${product.id}">
                                    <span class="material-icons" style="font-size: 1rem;">delete</span>
                                    Delete
                                </button>
                            ` : `
                                <button class="btn btn-small btn-secondary" disabled>
                                    <span class="material-icons" style="font-size: 1rem;">lock</span>
                                    Default Product
                                </button>
                            `}
                        </div>
                    </div>
                `;
                
                grid.appendChild(card);
            });
            
            // Add event listeners after DOM is created
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    console.log('Edit clicked via event listener:', productId);
                    editProduct(productId);
                });
            });
            
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    console.log('Delete clicked via event listener:', productId);
                    deleteProduct(productId);
                });
            });
        }

        // Update statistics
        function updateStats() {
            const totalProducts = allProducts.length;
            
            let avgPrice = 0;
            let totalValue = 0;
            
            if (totalProducts > 0) {
                const totalPrice = allProducts.reduce((sum, p) => {
                    const price = parseInt(p.price.replace('₹', '').replace(',', ''));
                    return sum + price;
                }, 0);
                avgPrice = Math.round(totalPrice / totalProducts);
                totalValue = totalPrice;
            }

            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('customProducts').textContent = totalProducts;
            document.getElementById('avgPrice').textContent = `₹${avgPrice.toLocaleString()}`;
            document.getElementById('totalValue').textContent = `₹${totalValue.toLocaleString()}`;
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            searchQuery = e.target.value;
            renderProducts();
        });

        // Edit product
        function editProduct(productId) {
            console.log('Attempting to edit product:', productId);
            console.log('All products:', allProducts);
            
            const product = allProducts.find(p => p.id === productId);
            if (!product) {
                console.error('Product not found:', productId);
                return;
            }

            console.log('Found product:', product);
            currentEditingProduct = product;
            
            // Populate form
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductPrice').value = product.price.replace('₹', '').replace(',', '');
            document.getElementById('editProductDescription').value = product.description;
            
            // Load features
            const featuresContainer = document.getElementById('editFeaturesContainer');
            featuresContainer.innerHTML = product.features.map((feature, index) => `
                <div class="feature-input-group">
                    <input type="text" class="edit-feature-input" value="${feature}" placeholder="e.g., Bluetooth 5.0">
                    <button type="button" class="remove-feature-btn" onclick="removeEditFeature(this)">
                        <span class="material-icons">close</span>
                    </button>
                </div>
            `).join('');

            // Show current image
            if (product.imageUrl) {
                document.getElementById('editPreviewImg').src = product.imageUrl;
                document.getElementById('editImagePreview').style.display = 'block';
            }

            // Show modal
            document.getElementById('editModal').classList.add('active');
            console.log('Modal should be visible now');
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditingProduct = null;
            document.getElementById('editForm').reset();
            document.getElementById('editImagePreview').style.display = 'none';
        }

        // Add edit feature
        function addEditFeature() {
            const container = document.getElementById('editFeaturesContainer');
            const featureGroup = document.createElement('div');
            featureGroup.className = 'feature-input-group';
            featureGroup.innerHTML = `
                <input type="text" class="edit-feature-input" placeholder="e.g., Bluetooth 5.0">
                <button type="button" class="remove-feature-btn" onclick="removeEditFeature(this)">
                    <span class="material-icons">close</span>
                </button>
            `;
            container.appendChild(featureGroup);
        }

        // Remove edit feature
        function removeEditFeature(button) {
            const container = document.getElementById('editFeaturesContainer');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        }

        // Save product
        async function saveProduct() {
            if (!currentEditingProduct) return;

            const name = document.getElementById('editProductName').value.trim();
            const price = document.getElementById('editProductPrice').value;
            const description = document.getElementById('editProductDescription').value.trim();
            
            const features = Array.from(document.querySelectorAll('.edit-feature-input'))
                .map(input => input.value.trim())
                .filter(value => value !== '');

            if (!name || !price || !description || features.length === 0) {
                alert('Please fill in all required fields and add at least one feature');
                return;
            }

            try {
                // Handle image upload if new image selected
                let imageUrl = currentEditingProduct.imageUrl;
                const imageInput = document.getElementById('editImageInput');
                
                if (imageInput.files.length > 0) {
                    const reader = new FileReader();
                    const base64Promise = new Promise((resolve) => {
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(imageInput.files[0]);
                    });
                    imageUrl = await base64Promise;
                }

                // Update product
                const updatedProduct = {
                    ...currentEditingProduct,
                    name,
                    price: `₹${price}`,
                    description,
                    imageUrl,
                    features,
                    updatedAt: new Date().toISOString()
                };

                // Save to JSONBin.io
                if (currentEditingProduct.id) {
                    // Update existing product
                    await window.productStorage.updateProduct(currentEditingProduct.id, updatedProduct);
                    showNotification('Product updated successfully!', 'success');
                } else {
                    // Add new product
                    await window.productStorage.addProduct(updatedProduct);
                    showNotification('Product added successfully!', 'success');
                }

                // Reload products
                loadProducts();
                closeEditModal();
                
            } catch (error) {
                console.error('Error saving product:', error);
                showNotification('Failed to save product. ' + error.message, 'error');
            }
        }

        // Delete product from JSONBin.io
        async function deleteProduct(productId) {
            console.log('Attempting to delete product:', productId);
            
            if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                return;
            }

            try {
                // Delete from JSONBin.io
                await window.productStorage.deleteProduct(productId);
                
                // Remove from local array
                allProducts = allProducts.filter(product => product.id !== productId);
                renderProducts();
                updateStats();
                
                showNotification('Product deleted successfully!', 'success');
                
            } catch (error) {
                console.error('Error deleting product:', error);
                showNotification('Failed to delete product: ' + error.message, 'error');
            }
        }

        // Show notification
        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                color: white;
                font-weight: 500;
                z-index: 2000;
                animation: slideIn 0.3s ease;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            `;
            
            if (type === 'success') {
                notification.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                notification.innerHTML = `<span class="material-icons" style="font-size: 1.25rem;">check_circle</span> ${message}`;
            } else {
                notification.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                notification.innerHTML = `<span class="material-icons" style="font-size: 1.25rem;">error</span> ${message}`;
            }
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Image upload handling for edit modal
        document.getElementById('editUploadArea').addEventListener('click', () => {
            document.getElementById('editImageInput').click();
        });

        document.getElementById('editImageInput').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('editPreviewImg').src = e.target.result;
                    document.getElementById('editImagePreview').style.display = 'block';
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        // Add animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // Initialize
        console.log('Initializing manage products page...');
        loadProducts();

        // Test modal functionality
        window.testModal = function() {
            console.log('Testing modal...');
            const modal = document.getElementById('editModal');
            console.log('Modal element:', modal);
            modal.classList.add('active');
            console.log('Modal classes after adding active:', modal.className);
        };

        // Listen for storage changes
        window.addEventListener('storage', (e) => {
            if (e.key === 'products') {
                loadProducts();
            }
        });

        // Refresh when window gains focus
        window.addEventListener('focus', () => {
            loadProducts();
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('editModal').classList.contains('active')) {
                closeEditModal();
            }
        });
    </script>
    <!-- Add product-storage.js -->
    <script src="js/product-storage.js"></script>
    <script>
        // Global variables
        const defaultProducts = [];
        let allProducts = [];
        let currentEditingProduct = null;
        let searchQuery = '';

        // Show notification function
        window.showNotification = function(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                padding: 12px 24px;
                border-radius: 8px;
                color: white;
                background-color: ${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#3b82f6'};
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 8px;
                max-width: 320px;
                animation: slideIn 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <span class="material-icons" style="font-size: 20px;">
                    ${type === 'error' ? 'error_outline' : type === 'success' ? 'check_circle' : 'info'}
                </span>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        };

        // Make loadProducts globally accessible
        window.loadProducts = async function() {
            try {
                console.log('Loading products...');
                const products = await window.productStorage.loadProducts();
                console.log('Products loaded:', products);
                allProducts = Array.isArray(products) ? products : [];
                renderProducts();
                updateStats();
                return allProducts;
            } catch (error) {
                console.error('Error loading products:', error);
                allProducts = [];
                renderProducts();
                updateStats();
                throw error;
            }
        };

        // Render products in the grid
        window.renderProducts = function() {
            const grid = document.getElementById('productsGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (!grid || !emptyState) {
                console.error('Required DOM elements not found');
                return;
            }

            // Clear existing content
            grid.innerHTML = '';

            if (!allProducts || allProducts.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            // Show products
            allProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <div class="product-image">
                        <img src="${product.imageUrl || 'https://placehold.co/300x200/f1f5f9/64748b?text=No+Image'}" 
                             alt="${product.name}" 
                             onerror="this.src='https://placehold.co/300x200/f1f5f9/64748b?text=Image+Not+Found'">
                    </div>
                    <div class="product-info">
                        <h3 class="product-name">${product.name || 'Unnamed Product'}</h3>
                        <div class="product-price">₹${product.price || '0.00'}</div>
                        <p class="product-description">${product.description || 'No description available.'}</p>
                        <div class="product-features">
                            ${(product.features && product.features.length > 0) ? 
                                product.features.slice(0, 3).map(feature => 
                                    `<span class="feature-tag">${feature}</span>`
                                ).join('') : 
                                '<span class="feature-tag">No features listed</span>'
                            }
                        </div>
                        <div class="product-actions">
                            <button class="btn btn-edit" data-id="${product.id}">
                                <span class="material-icons">edit</span> Edit
                            </button>
                            <button class="btn btn-delete" data-id="${product.id}">
                                <span class="material-icons">delete</span> Delete
                            </button>
                        </div>
                    </div>
                `;
                grid.appendChild(productCard);

                // Add event listeners for the buttons we just created
                const editBtn = productCard.querySelector('.btn-edit');
                const deleteBtn = productCard.querySelector('.btn-delete');

                // Edit button click handler
                editBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const productId = editBtn.getAttribute('data-id');
                    const product = allProducts.find(p => p.id === productId);
                    
                    if (!product) {
                        showNotification('Product not found', 'error');
                        return;
                    }

                    currentEditingProduct = product;
                    
                    // Fill the edit form with product data
                    document.getElementById('editProductName').value = product.name || '';
                    document.getElementById('editProductPrice').value = product.price || '';
                    document.getElementById('editProductDescription').value = product.description || '';
                    
                    // Handle features
                    const featuresContainer = document.getElementById('editFeaturesContainer');
                    featuresContainer.innerHTML = ''; // Clear existing features
                    
                    if (product.features && product.features.length > 0) {
                        product.features.forEach((feature, index) => {
                            addFeatureToEditForm(feature, index);
                        });
                    } else {
                        addFeatureToEditForm('', 0); // Add at least one empty feature field
                    }
                    
                    // Show the edit modal
                    document.getElementById('editModal').classList.add('active');
                    document.body.style.overflow = 'hidden';
                });

                // Delete button click handler
                deleteBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const productId = deleteBtn.getAttribute('data-id');
                    
                    if (confirm('Are you sure you want to delete this product?')) {
                        try {
                            // Filter out the product to be deleted
                            const updatedProducts = allProducts.filter(p => p.id !== productId);
                            
                            // Save the updated products list
                            await window.productStorage.saveProducts(updatedProducts);
                            
                            // Update the UI
                            allProducts = updatedProducts;
                            renderProducts();
                            updateStats();
                            
                            showNotification('Product deleted successfully', 'success');
                        } catch (error) {
                            console.error('Error deleting product:', error);
                            showNotification('Failed to delete product', 'error');
                        }
                    }
                });
            });

            grid.style.display = 'grid';
            emptyState.style.display = 'none';
        };

        // Helper function to add a feature to the edit form
        function addFeatureToEditForm(featureValue = '', index) {
            const featureId = `feature-${index}`;
            const featureDiv = document.createElement('div');
            featureDiv.className = 'feature-input-group';
            featureDiv.innerHTML = `
                <input type="text" 
                       id="${featureId}" 
                       value="${featureValue}" 
                       placeholder="Enter a feature" 
                       class="feature-input">
                <button type="button" class="btn-icon btn-remove-feature" onclick="removeEditFeature(this)">
                    <span class="material-icons">remove_circle</span>
                </button>
            `;
            document.getElementById('editFeaturesContainer').appendChild(featureDiv);
        }

        // Delete product
        window.deleteProduct = async function(productId) {
            try {
                // Filter out the product to be deleted
                const updatedProducts = allProducts.filter(p => p.id !== productId);
                
                // Save the updated products list
                await window.productStorage.saveProducts(updatedProducts);
                
                // Update the UI
                allProducts = updatedProducts;
                renderProducts();
                updateStats();
                
                return true;
            } catch (error) {
                console.error('Error deleting product:', error);
                throw error;
            }
        };

        // Close edit modal
        window.closeEditModal = function() {
            document.getElementById('editModal').classList.remove('active');
            document.body.style.overflow = '';
            currentEditingProduct = null;
        };

        // Add feature in edit form
        window.addEditFeature = function() {
            const features = document.querySelectorAll('.feature-input');
            const lastFeature = features[features.length - 1];
            
            // Only add a new feature if the last one is not empty
            if (!lastFeature || lastFeature.value.trim() !== '') {
                const newIndex = document.querySelectorAll('.feature-input').length;
                addFeatureToEditForm('', newIndex);
            }
        };

        // Remove feature in edit form
        window.removeEditFeature = function(button) {
            const featureGroups = document.querySelectorAll('.feature-input-group');
            if (featureGroups.length > 1) { // Keep at least one feature field
                button.closest('.feature-input-group').remove();
            }
        };

        // Save product
        window.saveProduct = async function() {
            try {
                const name = document.getElementById('editProductName').value.trim();
                const price = parseFloat(document.getElementById('editProductPrice').value);
                const description = document.getElementById('editProductDescription').value.trim();
                
                // Collect features
                const features = [];
                document.querySelectorAll('.feature-input').forEach(input => {
                    if (input.value.trim() !== '') {
                        features.push(input.value.trim());
                    }
                });
                
                // Basic validation
                if (!name) {
                    showNotification('Please enter a product name', 'error');
                    return;
                }
                
                if (isNaN(price) || price <= 0) {
                    showNotification('Please enter a valid price', 'error');
                    return;
                }
                
                // Create or update product
                const productData = {
                    id: currentEditingProduct ? currentEditingProduct.id : Date.now().toString(),
                    name,
                    price,
                    description,
                    features,
                    imageUrl: currentEditingProduct?.imageUrl || 'https://placehold.co/300x200/f1f5f9/64748b?text=No+Image'
                };
                
                // Update or add the product
                let updatedProducts;
                if (currentEditingProduct) {
                    // Update existing product
                    updatedProducts = allProducts.map(p => 
                        p.id === currentEditingProduct.id ? productData : p
                    );
                } else {
                    // Add new product
                    updatedProducts = [...allProducts, productData];
                }
                
                // Save to storage
                await window.productStorage.saveProducts(updatedProducts);
                
                // Update UI
                allProducts = updatedProducts;
                renderProducts();
                updateStats();
                closeEditModal();
                
                showNotification(
                    `Product ${currentEditingProduct ? 'updated' : 'added'} successfully`, 
                    'success'
                );
                
            } catch (error) {
                console.error('Error saving product:', error);
                showNotification('Failed to save product. Please try again.', 'error');
            }
        };

        // Update statistics
        window.updateStats = function() {
            const totalProducts = allProducts.length;
            const totalValue = allProducts.reduce((sum, product) => {
                const price = parseFloat(product.price) || 0;
                return sum + price;
            }, 0);
            const avgPrice = totalProducts > 0 ? (totalValue / totalProducts).toFixed(2) : 0;

            // Update the UI
            const totalEl = document.getElementById('totalProducts');
            const customEl = document.getElementById('customProducts');
            const avgPriceEl = document.getElementById('avgPrice');
            const totalValueEl = document.getElementById('totalValue');

            if (totalEl) totalEl.textContent = totalProducts;
            if (customEl) customEl.textContent = totalProducts; // Assuming all products are custom for now
            if (avgPriceEl) avgPriceEl.textContent = `₹${avgPrice}`;
            if (totalValueEl) totalValueEl.textContent = `₹${totalValue.toFixed(2)}`;
        };

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded, initializing...');
            // Load products when the page loads
            loadProducts().catch(error => {
                console.error('Failed to load products:', error);
                if (window.showNotification) {
                    showNotification('Failed to load products. Please check the console for details.', 'error');
                }
            });
        });

        // Add animation keyframes
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes fadeOut {
                from { opacity: 1; transform: translateX(0); }
                to { opacity: 0; transform: translateX(100%); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
